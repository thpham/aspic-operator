apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

bases:
- github.com/argoproj/argo-cd/manifests/cluster-install?ref=v2.4.7
- github.com/argoproj/argo-workflows/manifests/cluster-install?ref=v3.3.8
- github.com/argoproj/argo-events/manifests/cluster-install?ref=v1.7.1
- github.com/argoproj/argo-events/manifests/extensions/validating-webhook?ref=v1.7.1
- github.com/argoproj/argo-rollouts/manifests/cluster-install?ref=v1.2.2
- github.com/argoproj/argo-rollouts/manifests/notifications?ref=v1.2.2
- github.com/argoproj/argo-rollouts/manifests/dashboard-install?ref=v1.2.2

resources:
- namespace.yaml
- argocd-ingress.yaml
- rollouts-ingress.yaml
- workflows-ingress.yaml
- eventbus.yaml
- aspic-rbac.yaml
- aspic-eventsource.yaml
- aspic-us-sensor.yaml
- workflows-rbac.yaml
#- workflows-rolebinding.yaml

patches:
- path: argocd-cm.yaml
  target:
    kind: ConfigMap
    name: argocd-cm

- path: workflow-controller-configmap.yaml
  target:
    kind: ConfigMap
    name: workflow-controller-configmap

- path: argo-server-deployment.yaml
  target:
    kind: Deployment
    name: argo-server

- target:
    kind: ClusterRoleBinding|RoleBinding
  patch: |-
    - op: replace
      path: /subjects/0/namespace
      value: argocd

- target:
    namespace: argo|argo-events
  patch: |-
    - op: remove
      path: /metadata/namespace

- target:
    kind: Deployment
    name: argo-rollouts-dashboard
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: quay.io/argoproj/kubectl-argo-rollouts:v1.2.2
